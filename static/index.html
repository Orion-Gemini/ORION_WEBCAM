<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Web App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* CSS —Å—Ç–∏–ª–∏ –¥–ª—è TWA */
        :root {
            /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–º—ã Telegram */
            --tg-theme-bg-color: #fff;
            --tg-theme-secondary-bg-color: #f0f0f0;
            --tg-theme-text-color: #000;
            --tg-theme-hint-color: #999;
            --tg-theme-button-color: #007aff;
            --tg-theme-button-text-color: #fff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        #chat-window {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px 0;
            margin-bottom: 10px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 85%;
            line-height: 1.4;
        }
        .user {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .bot {
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        #input-container {
            display: flex;
            gap: 10px;
            padding: 5px 0;
        }
        #prompt-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--tg-theme-secondary-bg-color);
            border-radius: 20px;
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
        }
        button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:disabled {
            opacity: 0.6;
        }
        .file-info {
            font-size: 0.75em;
            color: var(--tg-theme-hint-color);
            margin-bottom: 5px;
            font-weight: 500;
        }
        /* –°—Ç–∏–ª—å –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∂–∏—Ä–Ω—ã–π, –∫—É—Ä—Å–∏–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–∏–π—Ç–∏ –∏–∑ Gemini) */
        .message * {
            white-space: pre-wrap; /* –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–µ—Ä–µ–≤–æ–¥—ã —Å—Ç—Ä–æ–∫ */
            word-wrap: break-word;
        }
    </style>
</head>
<body class="twa-ready">

    <div id="chat-window">
        <div class="message bot">
            üëã –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî Gemini Web App. –ó–∞–¥–∞–π—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª (—Ñ–æ—Ç–æ, PDF, TXT).
        </div>
    </div>

    <div id="input-container">
        <input type="file" id="file-input" style="display: none;" accept="image/*, application/pdf, text/plain">
        <button id="file-btn" onclick="document.getElementById('file-input').click()">üìé</button>
        <input type="text" id="prompt-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..." onkeydown="if(event.key === 'Enter') sendMessage()">
        <button id="send-btn" onclick="sendMessage()">‚¨ÜÔ∏è</button>
    </div>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const promptInput = document.getElementById('prompt-input');
        const fileInput = document.getElementById('file-input');
        const fileButton = document.getElementById('file-btn');
        const sendButton = document.getElementById('send-btn');
        let isSending = false;
        let currentFile = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TWA SDK
        if (window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–∞ —Ç–µ–º—ã Telegram
            const params = window.Telegram.WebApp.themeParams;
            document.documentElement.style.setProperty('--tg-theme-bg-color', params.bg_color || '#fff');
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', params.secondary_bg_color || '#f0f0f0');
            document.documentElement.style.setProperty('--tg-theme-text-color', params.text_color || '#000');
            document.documentElement.style.setProperty('--tg-theme-hint-color', params.hint_color || '#999');
            document.documentElement.style.setProperty('--tg-theme-button-color', params.button_color || '#007aff');
            document.documentElement.style.setProperty('--tg-theme-button-text-color', params.button_text_color || '#fff');

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
            window.Telegram.WebApp.MainButton.setText("–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é");
            window.Telegram.WebApp.MainButton.show();
            window.Telegram.WebApp.MainButton.onClick(resetHistory);
        }

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                currentFile = file;
                promptInput.placeholder = `–í–æ–ø—Ä–æ—Å –¥–ª—è —Ñ–∞–π–ª–∞: ${file.name}`;
                fileButton.style.backgroundColor = 'var(--tg-theme-hint-color)'; // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ —Ñ–∞–π–ª –≤—ã–±—Ä–∞–Ω
            } else {
                currentFile = null;
                promptInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å...';
                fileButton.style.backgroundColor = 'var(--tg-theme-button-color)';
            }
        });

        function appendMessage(text, sender, fileName = null) {
            const msg = document.createElement('div');
            msg.className = `message ${sender}`;

            let htmlContent = '';
            if (fileName) {
                htmlContent += `<div class="file-info">üìé ${fileName}</div>`;
            }

            // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã —Å—Ç—Ä–æ–∫ –Ω–∞ <br> –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ HTML
            htmlContent += text.replace(/\n/g, '<br>');

            msg.innerHTML = htmlContent;
            chatWindow.appendChild(msg);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        async function sendMessage() {
            if (isSending) return;
            const prompt = promptInput.value.trim();
            if (!prompt && !currentFile) return;

            isSending = true;
            sendButton.disabled = true;
            promptInput.disabled = true;
            fileButton.disabled = true;
            window.Telegram.WebApp.MainButton.showProgress(true);

            // 1. –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            appendMessage(prompt, 'user', currentFile ? currentFile.name : null);

            // 2. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è "–î—É–º–∞—é..."
            const thinkingMsg = document.createElement('div');
            thinkingMsg.className = 'message bot';
            thinkingMsg.innerHTML = '‚åõ –î—É–º–∞—é...';
            chatWindow.appendChild(thinkingMsg);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            // 3. –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            let fileDataBase64 = null;
            let mimeType = null;

            if (currentFile) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    // –ö–æ–¥–∏—Ä—É–µ–º —Ñ–∞–π–ª –≤ Base64 –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏. –ò—Å–ø–æ–ª—å–∑—É–µ–º slice(atob)
                    const binary = e.target.result;
                    const base64String = btoa(String.fromCharCode.apply(null, new Uint8Array(binary)));

                    fileDataBase64 = base64String;
                    mimeType = currentFile.type || 'application/octet-stream';
                    await sendRequest(prompt, fileDataBase64, mimeType, thinkingMsg);
                };
                reader.onerror = function() {
                    thinkingMsg.remove();
                    appendMessage("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞.", 'bot');
                    resetState();
                };
                // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ ArrayBuffer –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                reader.readAsArrayBuffer(currentFile);
            } else {
                await sendRequest(prompt, fileDataBase64, mimeType, thinkingMsg);
            }
        }

        async function sendRequest(prompt, fileDataBase64, mimeType, thinkingMsg) {
            try {
                // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º /api/chat –¥–ª—è Serverless Function Vercel
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        file_data: fileDataBase64,
                        mime_type: mimeType
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    thinkingMsg.remove();
                    appendMessage(data.text, 'bot');
                } else {
                    thinkingMsg.remove();
                    appendMessage(`‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'bot');
                }

            } catch (error) {
                thinkingMsg.remove();
                appendMessage(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'bot');
            } finally {
                window.Telegram.WebApp.MainButton.hideProgress();
                resetState();
            }
        }

        function resetState() {
            promptInput.value = '';
            currentFile = null;
            fileInput.value = '';
            promptInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å...';
            fileButton.style.backgroundColor = 'var(--tg-theme-button-color)';
            isSending = false;
            sendButton.disabled = false;
            promptInput.disabled = false;
            fileButton.disabled = false;
        }

        async function resetHistory() {
            window.Telegram.WebApp.showPopup({
                title: '–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏',
                message: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞?',
                buttons: [
                    {id: 'yes', type: 'destructive', text: '–î–∞, –æ—á–∏—Å—Ç–∏—Ç—å'},
                    {id: 'no', type: 'cancel', text: '–û—Ç–º–µ–Ω–∞'},
                ]
            }, async (buttonId) => {
                if (buttonId === 'yes') {
                    window.Telegram.WebApp.MainButton.showProgress(true);
                    try {
                         // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º /api/reset –¥–ª—è Serverless Function Vercel
                         const response = await fetch('/api/reset', { method: 'POST' });
                         if (response.ok) {
                             chatWindow.innerHTML = '<div class="message bot">‚úÖ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä.</div>';
                         } else {
                             window.Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.");
                         }
                    } catch (error) {
                         window.Telegram.WebApp.showAlert("–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏—Å—Ç–æ—Ä–∏–∏.");
                    } finally {
                         window.Telegram.WebApp.MainButton.hideProgress();
                    }
                }
            });
        }

    </script>
</body>
</html>